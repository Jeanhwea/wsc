name: Build macOS app

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "Water Sorter Tool"
        required: false
        default: "wsc"
      bundle_id:
        description: "macOS bundle identifier"
        required: false
        default: "io.github.jeanhwea.wsc"
  push:
    tags:
      - "v*"

jobs:
  build-macos:
    runs-on: macos-latest
    defaults:
      run:
        shell: bash
    env:
      APP_NAME: ${{ github.event.inputs.app_name || 'wsc' }}
      BUNDLE_ID: ${{ github.event.inputs.bundle_id || 'io.github.jeanhwea.wsc' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        run: |
          curl -Ls https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Create virtualenv and install deps
        run: |
          uv venv
          # 安装 PySide6 与打包器
          uv pip install --upgrade pip
          uv pip install PySide6 pyinstaller

      - name: Build .app with PyInstaller
        run: |
          # 以仓库根的 app.py 为入口，打包无控制台窗口的 .app
          uv run pyinstaller app.py \
            --name "$APP_NAME" \
            --windowed \
            --osx-bundle-identifier "$BUNDLE_ID" \
            --noconfirm

      - name: Create DMG
        run: |
          hdiutil create -volname "$APP_NAME" -srcfolder "dist/${APP_NAME}.app" -ov -format UDZO "dist/${APP_NAME}.dmg"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macos
          path: |
            dist/${{ env.APP_NAME }}.app
            dist/${{ env.APP_NAME }}.dmg